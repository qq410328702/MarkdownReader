<Window x:Class="MarkdownReader.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
        mc:Ignorable="d"
        Title="Markdown Reader"
        Height="700" Width="1100"
        MinHeight="400" MinWidth="600"
        WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
    </Window.Resources>

    <Window.InputBindings>
        <KeyBinding Key="O" Modifiers="Ctrl" x:Name="OpenFileKeyBinding" />
        <KeyBinding Key="F" Modifiers="Ctrl" x:Name="SearchKeyBinding" />
        <KeyBinding Key="E" Modifiers="Ctrl" x:Name="ExportKeyBinding" />
    </Window.InputBindings>

    <DockPanel LastChildFill="True">
        <!-- Menu Bar -->
        <Menu DockPanel.Dock="Top">
            <!-- File Menu -->
            <MenuItem Header="文件(_F)">
                <MenuItem Header="打开(_O)" x:Name="MenuOpen" InputGestureText="Ctrl+O" />
                <MenuItem Header="最近文件(_R)" x:Name="MenuRecentFiles">
                    <MenuItem Header="(空)" IsEnabled="False" />
                </MenuItem>
                <Separator />
                <MenuItem Header="退出(_X)" x:Name="MenuExit" />
            </MenuItem>

            <!-- Export Menu -->
            <MenuItem Header="导出(_E)">
                <MenuItem Header="导出为 HTML(_H)" x:Name="MenuExportHtml" />
                <MenuItem Header="导出为 PDF(_P)" x:Name="MenuExportPdf" />
            </MenuItem>

            <!-- Theme Menu -->
            <MenuItem Header="主题(_T)">
                <MenuItem Header="切换主题(_T)" x:Name="MenuToggleTheme" />
            </MenuItem>
        </Menu>

        <!-- Search Bar (collapsible) -->
        <Border DockPanel.Dock="Top"
                x:Name="SearchBar"
                Visibility="Collapsed"
                BorderBrush="#CCCCCC"
                BorderThickness="0,0,0,1"
                Padding="8,4">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBox x:Name="SearchTextBox"
                         Width="250"
                         Padding="4,2"
                         VerticalContentAlignment="Center"
                         Text="{Binding Search.SearchKeyword, UpdateSourceTrigger=PropertyChanged}" />

                <TextBlock x:Name="SearchMatchCount"
                           Text="{Binding Search.SearchMatchText}"
                           VerticalAlignment="Center"
                           Margin="8,0,4,0"
                           Foreground="Gray" />

                <Button x:Name="SearchPrevious"
                        Content="▲"
                        Width="28" Height="28"
                        Margin="2,0"
                        ToolTip="上一个匹配项"
                        Command="{Binding Search.SearchPreviousCommand}" />

                <Button x:Name="SearchNext"
                        Content="▼"
                        Width="28" Height="28"
                        Margin="2,0"
                        ToolTip="下一个匹配项"
                        Command="{Binding Search.SearchNextCommand}" />

                <Button x:Name="SearchClose"
                        Content="✕"
                        Width="28" Height="28"
                        Margin="8,0,0,0"
                        ToolTip="关闭搜索" />
            </StackPanel>
        </Border>

        <!-- Main Content Area: Sidebar + Splitter + WebView -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250" MinWidth="150" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" MinWidth="300" />
            </Grid.ColumnDefinitions>

            <!-- Sidebar: Table of Contents -->
            <Border Grid.Column="0"
                    BorderBrush="#CCCCCC"
                    BorderThickness="0,0,1,0">
                <DockPanel>
                    <TextBlock DockPanel.Dock="Top"
                               Text="目录"
                               FontWeight="SemiBold"
                               FontSize="14"
                               Padding="12,8"
                               Background="#F5F5F5" />
                    <TreeView x:Name="TocTreeView"
                              BorderThickness="0"
                              Padding="4"
                              ItemsSource="{Binding TocItems}"
                              SelectedItemChanged="TocTreeView_SelectedItemChanged">
                        <TreeView.ItemTemplate>
                            <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                <TextBlock Text="{Binding Title}"
                                           Padding="2"
                                           TextTrimming="CharacterEllipsis" />
                            </HierarchicalDataTemplate>
                        </TreeView.ItemTemplate>
                    </TreeView>
                </DockPanel>
            </Border>

            <!-- GridSplitter -->
            <GridSplitter Grid.Column="1"
                          Width="5"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Stretch"
                          Background="#E0E0E0"
                          ResizeBehavior="PreviousAndNext"
                          Cursor="SizeWE" />

            <!-- Main Content: WebView2 -->
            <wv2:WebView2 Grid.Column="2"
                          x:Name="ContentWebView" />

            <!-- Loading Overlay -->
            <Border Grid.Column="0" Grid.ColumnSpan="3"
                    x:Name="LoadingOverlay"
                    Background="#80000000"
                    Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
                <StackPanel HorizontalAlignment="Center"
                            VerticalAlignment="Center">
                    <ProgressBar IsIndeterminate="True"
                                 Width="200"
                                 Height="4" />
                    <TextBlock Text="加载中..."
                               Foreground="White"
                               FontSize="14"
                               HorizontalAlignment="Center"
                               Margin="0,12,0,0" />
                </StackPanel>
            </Border>

            <!-- Error Notification Bar -->
            <Border Grid.Column="0" Grid.ColumnSpan="3"
                    x:Name="ErrorBar"
                    VerticalAlignment="Top"
                    Background="#FDE8E8"
                    BorderBrush="#F5C6CB"
                    BorderThickness="0,0,0,1"
                    Padding="12,8"
                    Visibility="{Binding HasError, Converter={StaticResource BooleanToVisibilityConverter}}">
                <DockPanel>
                    <Button DockPanel.Dock="Right"
                            Content="✕"
                            Width="24" Height="24"
                            Background="Transparent"
                            BorderThickness="0"
                            Cursor="Hand"
                            VerticalAlignment="Center"
                            Command="{Binding DismissErrorCommand}"
                            ToolTip="关闭" />
                    <TextBlock Text="⚠"
                               Foreground="#B71C1C"
                               FontSize="14"
                               VerticalAlignment="Center"
                               Margin="0,0,8,0" />
                    <TextBlock x:Name="ErrorMessageText"
                               Text="{Binding ErrorMessage}"
                               Foreground="#B71C1C"
                               FontSize="13"
                               VerticalAlignment="Center"
                               TextWrapping="Wrap" />
                </DockPanel>
            </Border>
        </Grid>
    </DockPanel>
</Window>
